// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core Authentication & User Management
model User {
  id                    String    @id // Use Clerk user ID directly, no auto-generation
  email                 String    @unique
  passwordHash          String?   @map("password_hash") // Optional for OAuth users
  passwordHashAlgorithm String    @default("bcrypt") @map("password_hash_algorithm") // 'bcrypt' or 'argon2id'
  username              String?   @unique
  displayName           String?   @map("display_name")
  emailVerified         Boolean   @default(false) @map("email_verified")
  isActive              Boolean   @default(true) @map("is_active")
  twoFactorEnabled      Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret       String?   @map("two_factor_secret") // Encrypted TOTP secret
  googleId              String?   @unique @map("google_id") // Google OAuth ID
  profilePicture        String?   @map("profile_picture") // Profile picture URL
  authProvider          String    @default("local") @map("auth_provider") // 'local' or 'google'
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  lastLoginAt           DateTime? @map("last_login_at")

  // Relations
  wallets      Wallet[]
  sessions     UserSession[]
  preferences  UserPreferences?
  activityLogs ActivityLog[]
  addressBook  AddressBookEntry[]

  @@map("users")
  @@index([email])
  @@index([username])
  @@index([isActive])
}

// Secure Session Management
model UserSession {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  sessionToken String   @unique @map("session_token")
  refreshToken String   @unique @map("refresh_token")
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  lastUsedAt   DateTime @default(now()) @map("last_used_at")
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  isActive     Boolean  @default(true) @map("is_active")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
  @@index([userId])
  @@index([sessionToken])
  @@index([refreshToken])
  @@index([expiresAt])
}

// User Preferences and Settings
model UserPreferences {
  userId             String   @id @map("user_id")
  defaultNetwork     String   @default("ethereum") @map("default_network")
  preferredCurrency  String   @default("USD") @map("preferred_currency")
  theme              String   @default("dark")
  language           String   @default("en")
  timezone           String   @default("UTC")
  notifications      Json     @default("{}")
  privacySettings    Json     @default("{}") @map("privacy_settings")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// Wallet Management with Enhanced Security
model Wallet {
  id                   String   @id @default(cuid())
  userId               String   @map("user_id")
  name                 String   @default("My Wallet")
  description          String?
  walletType           String   @default("hd") @map("wallet_type") // 'hd', 'imported', 'hardware'
  encryptedMnemonic    String?  @map("encrypted_mnemonic") // Only for HD wallets
  encryptedPrivateKeys Json     @map("encrypted_private_keys") // Network-specific encrypted keys
  addresses            Json     // {"ethereum": "0x...", "bitcoin": "bc1..."}
  derivationPath       String?  @map("derivation_path") // HD wallet derivation path
  isActive             Boolean  @default(true) @map("is_active")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  lastAccessedAt       DateTime @default(now()) @map("last_accessed_at")

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@map("wallets")
  @@index([userId])
  @@index([isActive])
  @@index([walletType])
}

// Optimized Transaction Storage
model Transaction {
  id               String    @id @default(cuid())
  walletId         String    @map("wallet_id")
  network          String
  txHash           String    @map("tx_hash")
  blockNumber      BigInt?   @map("block_number")
  fromAddress      String    @map("from_address")
  toAddress        String    @map("to_address")
  amount           Decimal   @db.Decimal(36, 18) // High precision for crypto amounts
  tokenSymbol      String    @default("ETH") @map("token_symbol")
  tokenAddress     String?   @map("token_address")
  tokenDecimals    Int       @default(18) @map("token_decimals")
  status           String    @default("pending")
  gasUsed          BigInt?   @map("gas_used")
  gasPrice         Decimal?  @map("gas_price") @db.Decimal(36, 0) // Wei precision
  nonce            Int?
  transactionFee   Decimal?  @map("transaction_fee") @db.Decimal(36, 18)
  timestamp        DateTime
  isIncoming       Boolean   @map("is_incoming")
  usdValueAtTime   Decimal?  @map("usd_value_at_time") @db.Decimal(15, 2)
  category         String    @default("transfer")
  metadata         Json?
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@map("transactions")
  @@unique([txHash, network], name: "unique_tx_per_network")
  @@index([walletId])
  @@index([walletId, timestamp(sort: Desc)], name: "wallet_transactions_by_time")
  @@index([status])
  @@index([network])
  @@index([tokenSymbol])
  @@index([category])
  @@index([amount])
}

// Security Audit Trail
model ActivityLog {
  id           String   @id @default(cuid())
  userId       String?  @map("user_id")
  action       String
  resourceType String?  @map("resource_type")
  resourceId   String?  @map("resource_id")
  details      Json?
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  success      Boolean
  timestamp    DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("activity_logs")
  @@index([userId])
  @@index([timestamp(sort: Desc)])
  @@index([action])
}

// Address Book for Frequent Contacts
model AddressBookEntry {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  name       String
  address    String
  network    String
  notes      String?
  isFavorite Boolean  @default(false) @map("is_favorite")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("address_book")
  @@unique([userId, address, network], name: "unique_address_per_user_network")
  @@index([userId])
  @@index([network])
}

// Enhanced address book with security features
model AddressBook {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  label     String
  address   String
  network   String
  trusted   Boolean  @default(false)
  notes     String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("address_books")
  @@unique([userId, address], name: "unique_user_address")
  @@index([userId, isActive])
}

// Known scam addresses database
model ScamAddress {
  address   String   @id
  reason    String?
  source    String? // 'reported', 'verified', 'automated'
  severity  String   @default("high") // 'low', 'medium', 'high', 'critical'
  reportedAt DateTime @default(now()) @map("reported_at")
  verifiedAt DateTime? @map("verified_at")
  isActive  Boolean  @default(true) @map("is_active")

  @@map("scam_addresses")
  @@index([isActive])
}

// Suspicious addresses that need review
model SuspiciousAddress {
  address   String   @id
  reason    String?
  flaggedBy String?  @map("flagged_by")
  flaggedAt DateTime @default(now()) @map("flagged_at")
  reviewed  Boolean  @default(false)
  isActive  Boolean  @default(true) @map("is_active")

  @@map("suspicious_addresses")
  @@index([reviewed, isActive])
}

// Price Caching for Performance
model PriceCache {
  symbol      String   @id
  name        String
  priceUsd    Decimal  @map("price_usd") @db.Decimal(15, 8)
  marketCap   Decimal? @map("market_cap") @db.Decimal(20, 2)
  volume24h   Decimal? @map("volume_24h") @db.Decimal(20, 2)
  change24h   Decimal? @map("change_24h") @db.Decimal(10, 4)
  change7d    Decimal? @map("change_7d") @db.Decimal(10, 4)
  lastUpdated DateTime @default(now()) @map("last_updated")

  @@map("price_cache")
  @@index([lastUpdated])
}

// Enums for Type Safety
enum WalletType {
  HD       @map("hd")
  IMPORTED @map("imported")
  HARDWARE @map("hardware")

  @@map("wallet_type")
}

enum TransactionStatus {
  PENDING   @map("pending")
  CONFIRMED @map("confirmed")
  FAILED    @map("failed")
  DROPPED   @map("dropped")

  @@map("transaction_status")
}

enum TransactionCategory {
  TRANSFER @map("transfer")
  SWAP     @map("swap")
  DEFI     @map("defi")
  NFT      @map("nft")
  CONTRACT @map("contract")

  @@map("transaction_category")
}

enum ActivityAction {
  LOGIN              @map("login")
  LOGOUT             @map("logout")
  WALLET_CREATE      @map("wallet_create")
  WALLET_DELETE      @map("wallet_delete")
  TRANSACTION_SEND   @map("transaction_send")
  SETTINGS_UPDATE    @map("settings_update")
  PASSWORD_CHANGE    @map("password_change")
  TWO_FA_ENABLE      @map("2fa_enable")
  TWO_FA_DISABLE     @map("2fa_disable")

  @@map("activity_action")
}
