// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String?
  avatar       String?
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLogin    DateTime?

  // Relations
  wallets     Wallet[]
  preferences UserPreferences?

  @@map("users")
}

model UserPreferences {
  id              String  @id @default(cuid())
  userId          String  @unique
  defaultNetwork  String  @default("ethereum-mainnet")
  currency        String  @default("USD")
  theme           String  @default("dark")
  notifications   Json    @default("{}")
  language        String  @default("en")
  timezone        String  @default("UTC")
  updatedAt       DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model Wallet {
  id            String   @id @default(cuid())
  userId        String
  name          String   @default("My Wallet")
  description   String?
  encryptedData String   // Encrypted private keys and mnemonic
  addresses     Json     // {"ethereum": "0x...", "bitcoin": "1...", "solana": "..."}
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastAccessed  DateTime @default(now())

  // Relations
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions        Transaction[]
  portfolioSnapshots  PortfolioSnapshot[]
  watchedTokens       WatchedToken[]

  @@map("wallets")
}

model Transaction {
  id            String   @id @default(cuid())
  walletId      String
  network       String   // ethereum-mainnet, polygon-mainnet, etc.
  txHash        String   @unique
  fromAddress   String
  toAddress     String
  amount        String   // Stored as string to handle large numbers
  tokenSymbol   String   @default("ETH")
  tokenAddress  String?
  status        String   // success, failed, pending
  blockNumber   BigInt?
  gasUsed       BigInt?
  gasPrice      String?
  nonce         Int?
  timestamp     DateTime
  isIncoming    Boolean  // true if receiving, false if sending
  usdValue      Decimal? @db.Decimal(18, 2)
  category      String?  // send, receive, swap, contract_interaction
  metadata      Json?    // Additional transaction data
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId, timestamp])
  @@index([txHash])
  @@index([network])
  @@map("transactions")
}

model PortfolioSnapshot {
  id           String   @id @default(cuid())
  walletId     String
  network      String
  totalValueUSD Decimal @db.Decimal(18, 2)
  balances     Json     // {"ETH": "1.5", "USDC": "1000", ...}
  tokenPrices  Json     // {"ETH": 2000, "USDC": 1, ...}
  snapshotDate DateTime @db.Date
  createdAt    DateTime @default(now())

  // Relations
  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([walletId, network, snapshotDate])
  @@index([walletId, snapshotDate])
  @@map("portfolio_snapshots")
}

model WatchedToken {
  id           String   @id @default(cuid())
  walletId     String
  network      String
  tokenAddress String
  tokenSymbol  String
  tokenName    String
  decimals     Int
  isActive     Boolean  @default(true)
  addedAt      DateTime @default(now())

  // Relations
  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@unique([walletId, network, tokenAddress])
  @@map("watched_tokens")
}

model PriceCache {
  id          String   @id @default(cuid())
  coinId      String   @unique // ethereum, bitcoin, polygon, etc.
  symbol      String
  name        String
  currentPrice Decimal @db.Decimal(18, 8)
  marketCap   Decimal? @db.Decimal(20, 2)
  volume24h   Decimal? @db.Decimal(20, 2)
  change24h   Decimal? @db.Decimal(10, 4)
  change7d    Decimal? @db.Decimal(10, 4)
  lastUpdated DateTime @default(now())
  createdAt   DateTime @default(now())

  @@map("price_cache")
}

model ApiUsage {
  id          String   @id @default(cuid())
  endpoint    String
  method      String
  userId      String?
  walletId    String?
  network     String?
  responseTime Int     // in milliseconds
  status      Int      // HTTP status code
  timestamp   DateTime @default(now())

  @@index([endpoint, timestamp])
  @@index([userId, timestamp])
  @@map("api_usage")
}
